@model IEnumerable<Photo>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager
@{
	Layout = "_Layout";
	ViewData["Title"] = "Cài đặt tài khoản";
	string userId = UserManager.GetUserId(User);
}

<div class="d-flex container my-5 py-5">
	<div class="d-flex flex-column pe-5 flex-shrink-0">
		<h4 class="my-3">Cài đặt tài khoản</h4>
		<a href="/accounts/info" class="my-2 link-secondary">Cập nhật thông tin</a>
		<a href="/accounts/history" class="my-2 link-secondary link-underline-light">Lịch sử download</a>
		<a href="/accounts/changePassword" class="my-2 link-secondary">Thay đổi mật khẩu</a>
		<a href="/accounts/delete" class="my-2 link-secondary">Xoá tài khoản</a>
	</div>
	<div class="w-100">
		<div class="d-flex align-items-center">
			<h4 class="my-3 me-auto">Lịch sử download</h4>
			@if (Model.Count() != 0)
			{
				<button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteHistoryModal">Xoá lịch
					sử</button>
			}
		</div>
		<div class="row">
			@if (Model.Count() == 0)
			{
				<div class="text-center">
					<img src="https://unsplash-assets.imgix.net/empty-states/photos.png?auto=format&fit=crop&q=60" alt=""
						class="w-25">
				</div>
			}
			else
			{
				@foreach (var item in Model)
				{
					<div class="col-4 my-3">
						<div class="card">
							<a class="p-3 text-decoration-none link-dark" href="/accounts/&#64;@item.User.UserName/profile">
								<img style="width: 32px; height: 32px; object-fit: cover" class="rounded-circle" src="@item.User.Thumbnail"
									alt="" />
								<span class="fw-bold">@item.User.UserName</span>
							</a>
							<img class="card-img-top btn-view" src="@item.Thumbnail" alt="Card image" style="cursor: zoom-in;"
								data-bs-toggle="modal" data-bs-target="#viewPictureModal" data-url="/photos/view/@item.Id" />
							<div class="card-body d-flex">
								@{
									var isLikedByCurrentUser = (userId != null) && item.Likes.Any(l => l.UserId == userId);
								}
								<button class="btn @(isLikedByCurrentUser?"btn-outline-danger":"btn-outline-secondary") me-2 btn-like"
									data-url="/photos/like/@item.Id">
									<i class="bi bi-heart-fill"></i>
								</button>
								<button class="btn btn-outline-secondary me-auto btn-collection" data-url="@item.Id"><i
										class="bi bi-plus-square"></i></button>
								<button class="btn btn-outline-secondary btn-download" data-url="/photos/download/@item.Id"><i
										class="bi bi-download"></i> Download</button>
							</div>
						</div>
					</div>
				}
			}
		</div>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="deleteHistoryModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">Xoá lịch sử</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				Việc này không thể hoàn tác.
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ bỏ</button>
				<button type="button" class="btn btn-primary" id="btnDeleteHistory">Xoá</button>
			</div>
		</div>
	</div>
</div>
<!-- /Modal -->
@section js {
	<script>
		let userId = '@userId';
	</script>
	<script>
		const deleteHistoryModal = new bootstrap.Modal('#deleteHistoryModal');
		$("#btnDeleteHistory").click(function () {
			$.ajax({
				type: 'get',
				contentType: 'application/json; charset=utf-8',
				url: "/accounts/historyDelete",
				success: function (response) {
					deleteHistoryModal.hide();
					window.location.reload();
				},
				error: function () {
					console.log('Error');
				},
			});
		})
	</script>
}